<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - Natasha Sammy Analytics</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
        }

        /* Login Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            backdrop-filter: blur(10px);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .login-header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px 40px 12px 15px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2a5298;
        }

        .form-group i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            min-height: 100vh;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar h1 {
            color: #333;
            font-size: 24px;
        }

        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #c82333;
        }

        .container {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 12px;
            color: #28a745;
        }

        .chart-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .chart-container h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .controls-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .controls-section h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .country-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e1e1e1;
            border-radius: 5px;
        }

        .country-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        .country-item:last-child {
            border-bottom: none;
        }

        .country-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flag {
            font-size: 20px;
        }

        .block-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .block-btn.blocked {
            background: #28a745;
        }

        .block-btn:hover {
            opacity: 0.8;
        }

        .visitor-log {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .visitor-log h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .log-table th,
        .log-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e1e1;
        }

        .log-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        @media (max-width: 768px) {
            .chart-section {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 15px;
            }
            
            .navbar {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h2><i class="fas fa-chart-line"></i> Panel de Administración</h2>
                <p>Natasha Sammy Analytics</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario:</label>
                    <input type="text" id="username" name="username" required>
                    <i class="fas fa-user"></i>
                </div>
                <div class="form-group">
                    <label for="password">Contraseña:</label>
                    <input type="password" id="password" name="password" required>
                    <i class="fas fa-lock"></i>
                </div>
                <button type="submit" class="login-btn">
                    <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
                </button>
                <div id="errorMessage" class="error-message">
                    Usuario o contraseña incorrectos
                </div>
            </form>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard" class="dashboard">
        <nav class="navbar">
            <h1><i class="fas fa-chart-line"></i> Dashboard Analytics</h1>
            <button onclick="logout()" class="logout-btn">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        </nav>

        <div class="container">
            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total de Clics</h3>
                    <div class="number" id="totalClicks">0</div>
                </div>
                <div class="stat-card">
                    <h3>Visitantes Únicos</h3>
                    <div class="number" id="uniqueVisitors">0</div>
                </div>
                <div class="stat-card">
                    <h3>Países Activos</h3>
                    <div class="number" id="activeCountries">0</div>
                </div>
                <div class="stat-card">
                    <h3>Hoy</h3>
                    <div class="number" id="todayClicks">0</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="chart-section">
                <div class="chart-container">
                    <h3><i class="fas fa-chart-area"></i> Clics por Día (Últimos 7 días)</h3>
                    <canvas id="clicksChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3><i class="fas fa-globe"></i> Top 5 Países</h3>
                    <canvas id="countriesChart"></canvas>
                </div>
            </div>

            <!-- Country Controls -->
            <div class="controls-section">
                <h3><i class="fas fa-ban"></i> Control de Países</h3>
                <button onclick="refreshData()" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Actualizar Datos
                </button>
                <div class="country-list" id="countryList">
                    <!-- Countries will be populated by JavaScript -->
                </div>
            </div>

            <!-- Visitor Log -->
            <div class="visitor-log">
                <h3><i class="fas fa-list"></i> Registro de Visitantes (Últimos 50)</h3>
                <div style="overflow-x: auto;">
                    <table class="log-table">
                        <thead>
                            <tr>
                                <th>Fecha/Hora</th>
                                <th>País</th>
                                <th>Ciudad</th>
                                <th>IP</th>
                                <th>Dispositivo</th>
                                <th>Referrer</th>
                            </tr>
                        </thead>
                        <tbody id="visitorTableBody">
                            <!-- Visitor data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Authentication
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'admin' && password === '1234') {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadDashboardData();
            } else {
                document.getElementById('errorMessage').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('errorMessage').style.display = 'none';
                }, 3000);
            }
        });

        function logout() {
            document.getElementById('loginSection').style.display = 'flex';
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        // Dashboard functionality
        let clicksChart, countriesChart;

        function loadDashboardData() {
            const visitorData = JSON.parse(localStorage.getItem('visitorData') || '[]');
            updateStatistics(visitorData);
            createCharts(visitorData);
            populateCountryList(visitorData);
            populateVisitorTable(visitorData);
        }

        function updateStatistics(data) {
            const totalClicks = data.length;
            const uniqueVisitors = new Set(data.map(v => v.ipLocation?.ip || 'unknown')).size;
            const activeCountries = new Set(data.map(v => v.ipLocation?.country || 'Unknown')).size;
            
            // Calcular clics de hoy
            const today = new Date().toISOString().split('T')[0];
            const todayClicks = data.filter(v => v.timestamp.split('T')[0] === today).length;

            document.getElementById('totalClicks').textContent = totalClicks;
            document.getElementById('uniqueVisitors').textContent = uniqueVisitors;
            document.getElementById('activeCountries').textContent = activeCountries;
            document.getElementById('todayClicks').textContent = todayClicks;
        }

        function createCharts(data) {
            // Clicks by day chart
            const last7Days = [];
            const clicksByDay = {};
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                last7Days.push(dateStr);
                clicksByDay[dateStr] = 0;
            }

            data.forEach(visitor => {
                const date = visitor.timestamp.split('T')[0];
                if (clicksByDay.hasOwnProperty(date)) {
                    clicksByDay[date]++;
                }
            });

            const ctx1 = document.getElementById('clicksChart').getContext('2d');
            if (clicksChart) clicksChart.destroy();
            
            clicksChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: last7Days.map(date => {
                        const d = new Date(date);
                        return d.getDate() + '/' + (d.getMonth() + 1);
                    }),
                    datasets: [{
                        label: 'Clics',
                        data: last7Days.map(date => clicksByDay[date]),
                        borderColor: '#2a5298',
                        backgroundColor: 'rgba(42, 82, 152, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });

            // Countries chart
            const countryCounts = {};
            data.forEach(visitor => {
                const country = visitor.ipLocation?.country || 'Sin ubicación';
                countryCounts[country] = (countryCounts[country] || 0) + 1;
            });

            const sortedCountries = Object.entries(countryCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);

            const ctx2 = document.getElementById('countriesChart').getContext('2d');
            if (countriesChart) countriesChart.destroy();
            
            // Solo mostrar gráfica si hay datos
            if (sortedCountries.length > 0) {
                countriesChart = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: sortedCountries.map(([country]) => country),
                        datasets: [{
                            data: sortedCountries.map(([, count]) => count),
                            backgroundColor: [
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0',
                                '#9966FF'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            } else {
                // Mostrar mensaje cuando no hay datos
                ctx2.font = '16px Arial';
                ctx2.fillStyle = '#666';
                ctx2.textAlign = 'center';
                ctx2.fillText('Sin datos disponibles', ctx2.canvas.width/2, ctx2.canvas.height/2);
            }
        }

        function populateCountryList(data) {
            const countryCounts = {};
            const countryFlags = {
                'Spain': '🇪🇸', 'United States': '🇺🇸', 'Mexico': '🇲🇽', 'Argentina': '🇦🇷',
                'Colombia': '🇨🇴', 'Venezuela': '🇻🇪', 'Peru': '🇵🇪', 'Chile': '🇨🇱',
                'Uruguay': '🇺🇾', 'Paraguay': '🇵🇾', 'Ecuador': '🇪🇨', 'Bolivia': '🇧🇴',
                'France': '🇫🇷', 'Germany': '🇩🇪', 'Italy': '🇮🇹', 'United Kingdom': '🇬🇧',
                'Portugal': '🇵🇹', 'Brazil': '🇧🇷', 'Canada': '🇨🇦', 'Sin ubicación': '🏳️'
            };

            data.forEach(visitor => {
                const country = visitor.ipLocation?.country || 'Sin ubicación';
                countryCounts[country] = (countryCounts[country] || 0) + 1;
            });

            const blockedCountries = JSON.parse(localStorage.getItem('blockedCountries') || '[]');
            const countryList = document.getElementById('countryList');
            
            countryList.innerHTML = '';
            
            if (Object.keys(countryCounts).length === 0) {
                countryList.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">No hay datos de países disponibles</div>';
                return;
            }
            
            Object.entries(countryCounts)
                .sort(([,a], [,b]) => b - a)
                .forEach(([country, count]) => {
                    const countryCode = getCountryCode(country);
                    const isBlocked = blockedCountries.includes(countryCode);
                    
                    const countryItem = document.createElement('div');
                    countryItem.className = 'country-item';
                    countryItem.innerHTML = `
                        <div class="country-info">
                            <span class="flag">${countryFlags[country] || '🏳️'}</span>
                            <span>${country} (${count} ${count === 1 ? 'visita' : 'visitas'})</span>
                        </div>
                        <button class="block-btn ${isBlocked ? 'blocked' : ''}" 
                                onclick="toggleCountryBlock('${countryCode}', '${country}')">
                            ${isBlocked ? 'Desbloquear' : 'Bloquear'}
                        </button>
                    `;
                    countryList.appendChild(countryItem);
                });
        }

        function getCountryCode(countryName) {
            const countryCodes = {
                'Spain': 'ES', 'United States': 'US', 'Mexico': 'MX', 'Argentina': 'AR',
                'Colombia': 'CO', 'Venezuela': 'VE', 'Peru': 'PE', 'Chile': 'CL',
                'Uruguay': 'UY', 'Paraguay': 'PY', 'Ecuador': 'EC', 'Bolivia': 'BO',
                'France': 'FR', 'Germany': 'DE', 'Italy': 'IT', 'United Kingdom': 'GB',
                'Portugal': 'PT', 'Brazil': 'BR', 'Canada': 'CA', 'Sin ubicación': 'XX'
            };
            return countryCodes[countryName] || 'XX';
        }

        function toggleCountryBlock(countryCode, countryName) {
            const blockedCountries = JSON.parse(localStorage.getItem('blockedCountries') || '[]');
            const index = blockedCountries.indexOf(countryCode);
            
            if (index > -1) {
                blockedCountries.splice(index, 1);
                alert(`${countryName} ha sido desbloqueado`);
            } else {
                blockedCountries.push(countryCode);
                alert(`${countryName} ha sido bloqueado`);
            }
            
            localStorage.setItem('blockedCountries', JSON.stringify(blockedCountries));
            loadDashboardData(); // Refresh the display
        }

        function populateVisitorTable(data) {
            const tableBody = document.getElementById('visitorTableBody');
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="6" style="text-align: center; padding: 20px; color: #666;">No hay visitantes registrados</td>';
                tableBody.appendChild(row);
                return;
            }
            
            // Show last 50 visitors
            const recentVisitors = data.slice(-50).reverse();
            
            recentVisitors.forEach(visitor => {
                const row = document.createElement('tr');
                const date = new Date(visitor.timestamp);
                const formattedDate = date.toLocaleDateString('es-ES') + ' ' + date.toLocaleTimeString('es-ES');
                
                row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${visitor.ipLocation?.country || 'Sin ubicación'}</td>
                    <td>${visitor.ipLocation?.city || 'Sin ciudad'}</td>
                    <td>${visitor.ipLocation?.ip || 'Sin IP'}</td>
                    <td>${getDeviceType(visitor.userAgent)}</td>
                    <td>${visitor.referrer || 'Directo'}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        function getDeviceType(userAgent) {
            if (/Mobile|Android|iPhone|iPad/.test(userAgent)) {
                return 'Móvil';
            } else if (/Tablet/.test(userAgent)) {
                return 'Tablet';
            } else {
                return 'Desktop';
            }
        }

        function refreshData() {
            loadDashboardData();
            alert('Datos actualizados correctamente');
        }

        // Auto-refresh every 30 seconds if dashboard is visible
        setInterval(() => {
            if (document.getElementById('dashboard').style.display === 'block') {
                loadDashboardData();
            }
        }, 30000);
    </script>
</body>
</html>
